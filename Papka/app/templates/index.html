<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}Клиенты - CRM Golden House{% endblock %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="card-title h3 mb-0">Список клиентов</h1>
                <p class="card-text text-muted mb-0">Здесь отображаются клиенты, у которых есть номер телефона и номер договора.</p>
            </div>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createGeneralApplicationModal">
                <i class="bi bi-plus-circle me-1"></i> Создать заявку без клиента
            </button>
        </div>

        <!-- Форма поиска -->
        <form method="get" action="{{ url_for('main.index') }}" class="mb-4">
            <div class="input-group">
                <input type="text" class="form-control" name="search" placeholder="Поиск по ФИО или номеру договора..." value="{{ search_query or '' }}">
                <button class="btn btn-primary" type="submit">Найти</button>
            </div>
        </form>

        <!-- Таблица клиентов -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">ФИО Клиента</th>
                        <th scope="col">Телефон</th>
                        <th scope="col">Номера договоров</th>
                        <th scope="col" class="text-end">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr>
                        <td><strong>{{ client.fio }}</strong></td>
                        <td>{{ client.phone }}</td>
                        <td>
                            {% for number in client.agreement_numbers %}
                                <span class="badge bg-secondary fw-normal">{{ number }}</span>
                            {% endfor %}
                        </td>
                        <td class="text-end">
                            <!-- Ссылка активирована и ведет на карточку клиента -->
                            <a href="{{ url_for('main.client_card', client_id=client.id) }}" class="btn btn-sm btn-outline-dark">Посмотреть</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            {% if search_query %}
                            <p>Клиенты по запросу "{{ search_query }}" не найдены.</p>
                            <a href="{{ url_for('main.index') }}" class="btn btn-primary">Сбросить поиск</a>
                            {% else %}
                            <p>Клиенты не найдены.</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Пагинация -->
        {% if pagination and pagination.pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.index', page=pagination.prev_num, search=search_query) }}">‹</a>
                </li>
                {% for p in pagination.iter_pages() %}
                    {% if p %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.index', page=p, search=search_query) }}">{{ p }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.index', page=pagination.next_num, search=search_query) }}">›</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Модальное окно создания заявки без клиента -->
<div class="modal fade" id="createGeneralApplicationModal" tabindex="-1" aria-labelledby="createGeneralApplicationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createGeneralApplicationModalLabel">Создание заявки без привязки к клиенту</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('main.create_general_application') }}" method="post">
        <div class="modal-body">
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                Заявка будет создана без привязки к конкретному клиенту. Вы можете указать контактные данные и детали проблемы.
            </div>
            
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="contact_name" name="contact_name" placeholder="ФИО обратившегося">
                <label for="contact_name">ФИО обратившегося (опционально)</label>
            </div>
            
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="contact_phone" name="contact_phone" placeholder="Телефон">
                <label for="contact_phone">Телефон для связи (опционально)</label>
            </div>
            
            <div class="form-floating mb-3">
                <select class="form-select" id="application_type_general" name="application_type" required>
                    <option value="" selected>Выберите тип...</option>
                    {% for app_type in application_types %}
                    <option value="{{ app_type.name }}" data-has-defects="{{ 'true' if app_type.has_defect_list else 'false' }}">{{ app_type.name }}</option>
                    {% endfor %}
                </select>
                <label for="application_type_general">Тип заявки</label>
            </div>

            <div id="defect_fields_wrapper_general" style="display: none;">
                <div class="p-3 border rounded bg-light mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Информация о дефектах</h6>
                        <button type="button" id="add_defect_button_general" class="btn btn-sm btn-success">
                            <i class="bi bi-plus-circle me-1"></i> Добавить дефект
                        </button>
                    </div>
                    <div id="defects_container_general"></div>
                </div>
            </div>

            <div class="form-floating mb-3">
                <textarea class="form-control" id="comment_general" name="comment" placeholder="Описание проблемы" required style="height: 100px"></textarea>
                <label for="comment_general">Описание проблемы / комментарий</label>
            </div>

            <div class="form-floating mb-3">
                <select class="form-select" id="source_general" name="source" required>
                    <option value="" selected>Выберите источник заявки...</option>
                    <option value="Звонок">Звонок</option>
                    <option value="Email">Email</option>
                    <option value="Личный визит">Личный визит</option>
                    <option value="Сайт">Сайт</option>
                    <option value="Другое">Другое</option>
                </select>
                <label for="source_general">Источник заявки</label>
            </div>
            
            <div class="form-floating mb-3" id="custom_source_div_general" style="display: none;">
                <input type="text" class="form-control" id="custom_source_general" name="custom_source" placeholder="Укажите источник">
                <label for="custom_source_general">Укажите источник</label>
            </div>

            <div class="form-floating mb-3">
                <select class="form-select" id="responsible_person_general" name="responsible_person_id" required>
                    <option value="" selected>Выберите ответственного...</option>
                    {% for person in responsible_persons %}
                    <option value="{{ person.id }}">{{ person.full_name }}</option>
                    {% endfor %}
                </select>
                <label for="responsible_person_general">Ответственный</label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Создать заявку</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Обработка изменения источника заявки
    const sourceSelect = document.getElementById('source_general');
    const customSourceDiv = document.getElementById('custom_source_div_general');
    
    if (sourceSelect) {
        sourceSelect.addEventListener('change', function() {
            if (this.value === 'Другое') {
                customSourceDiv.style.display = 'block';
            } else {
                customSourceDiv.style.display = 'none';
            }
        });
    }
    
    // Обработка типа заявки для дефектов
    const applicationTypeSelect = document.getElementById('application_type_general');
    const defectWrapper = document.getElementById('defect_fields_wrapper_general');
    const defectsContainer = document.getElementById('defects_container_general');
    const addDefectButton = document.getElementById('add_defect_button_general');
    const defectTypes = {{ defect_types | tojson | safe }};
    let defectCounter = 0;

    function addDefectRow() {
        const index = defectCounter++;
        const defectRow = document.createElement('div');
        defectRow.className = 'defect-row row gx-2 mb-2 align-items-center';
        defectRow.setAttribute('data-index', index);
        let optionsHtml = '<option value="" selected>Выберите тип...</option>';
        defectTypes.forEach(type => { optionsHtml += `<option value="${type.name}">${type.name}</option>`; });

        defectRow.innerHTML = `
            <div class="col-md-5 form-floating">
                <select class="form-select form-select-sm" name="defects-${index}-type" id="defect-type-general-${index}" required>${optionsHtml}</select>
                <label for="defect-type-general-${index}">Тип дефекта</label>
            </div>
            <div class="col-md-6 form-floating">
                <input type="text" class="form-control form-control-sm" name="defects-${index}-description" id="defect-desc-general-${index}" placeholder="Комментарий к дефекту" required>
                <label for="defect-desc-general-${index}">Комментарий</label>
            </div>
            <div class="col-md-1 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger remove-defect-btn"><i class="bi bi-trash"></i></button>
            </div>`;
        defectsContainer.appendChild(defectRow);
        defectRow.querySelector('.remove-defect-btn').addEventListener('click', function () { defectRow.remove(); });
    }

    if (applicationTypeSelect) {
        applicationTypeSelect.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const hasDefects = selectedOption.getAttribute('data-has-defects') === 'true';

            if (hasDefects) {
                defectWrapper.style.display = 'block';
                if (defectsContainer.children.length === 0) { addDefectRow(); }
            } else {
                defectWrapper.style.display = 'none';
                defectsContainer.innerHTML = '';
                defectCounter = 0;
            }
        });
    }

    if (addDefectButton) {
        addDefectButton.addEventListener('click', addDefectRow);
    }
});
</script>
{% endblock %}
